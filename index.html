<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Daniel Duan</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:300,300i,600">
  <link rel="stylesheet" href="/style.css">
  <link rel="alternate" type="application/rss+xml" title="RSS Feed for Daniel Duan" href="/feed.xml" />
  <!-- Begin Jekyll SEO tag v2.4.0 -->
<title>Daniel Duan | Daniel Duan‚Äôs Thoughts And Works.</title>
<meta name="generator" content="Jekyll v3.6.2" />
<meta property="og:title" content="Daniel Duan" />
<meta name="author" content="Daniel Duan" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Daniel Duan‚Äôs Thoughts And Works." />
<meta property="og:description" content="Daniel Duan‚Äôs Thoughts And Works." />
<link rel="canonical" href="https://duan.ca/" />
<meta property="og:url" content="https://duan.ca/" />
<meta property="og:site_name" content="Daniel Duan" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@daniel_duan" />
<meta name="twitter:creator" content="@Daniel Duan" />
<script type="application/ld+json">
{"name":"Daniel Duan","description":"Daniel Duan‚Äôs Thoughts And Works.","author":{"@type":"Person","name":"Daniel Duan"},"@type":"WebSite","url":"https://duan.ca/","headline":"Daniel Duan","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>
<body>
  <div class="container">
    <header class="masthead">
  <h1 class="masthead-title">
    <a href="/">Daniel Duan<span>&#39;s blog</span></a>
  </h1>
  <nav class="masthead-nav">
    
    <a href="/articles">articles</a>
    
    <a href="https://www.youtube.com/channel/UCkBVC0dMgyUnxzettP7qE-A">videos</a>
    
    <a href="/links">Links</a>
    
    <a href="/projects">Projects</a>
    
    <a href="/about">About</a>
    
  </nav>
</header>
<div class="content page">
  <h3 class="page-title"></h3>
  


  
  <div class="content post">
    
    <h1 class="post-title"><a href="">üîó </a></h1>
    
    <div class="post-date">
      
      <a href="/linked/2018/08/2018-08-30-se0225/">
      
      <time>30 Aug 2018</time>
      
      </a>
      
      
    </div>
    <p>This announcement comes with some answers to ‚Äúwhat should be in the Swift
standard library?‚Äù</p>

<p>Notably:</p>

<blockquote>
  <p>Almost all library features can be composed from existing features with enough
effort. To be considered for addition to the library, a proposed feature must
satisfy two conditions: it must provide functionality that is useful to
a substantial population of Swift programmers, and it must provide substantial
advantages over the alternative ways of accomplishing that functionality.
Potential advantages include:</p>

  <p>It may be complex, challenging, or error-prone for users to implement
themselves.  It may have substantial performance advantages over a user
implementation, either because it has access to library internals or just
because the library implementation will likely be more carefully tuned.  It may
be substantially easier to work with because it composes better with other
language or library features.  It may be substantially more ‚Äúfluent‚Äù: that is,
more natural to discover, use, and read in code. The implementation may involve
composing primitives in a subtle or tricky way, or the primitives may be
unfamiliar to many programmers. This is a more subjective criterion than the
others, and people may reasonably differ about how to apply it.  For example,
consider adding an method to rotate the elements of an array. This operation can
be performed using a relatively simple composition of slicing and concatenation:</p>

  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>array = array[amount...] + array[..&lt;amount]
</code></pre></div>  </div>

  <p>However, a method to rotate an array in-place would still be welcome: it would
have substantial performance advantages, it would avoid several potential
off-by-one errors, and it would be significantly easier for a reader to
recognize as a rotation.</p>

  <p>In contrast, a property like <code class="highlighter-rouge">isNotEmpty</code> offers no substantial advantages over
<code class="highlighter-rouge">!isEmpty</code>, and adding it would open the door to adding trivial negations of
essentially every predicate.</p>
</blockquote>

  </div>
  <hr />
  
  <div class="content post">
    
    <h1 class="post-title"><a href="/2018/08/25/a-tale-of-two-dates/">A Tale of Two Dates</a></h1>
    
    <div class="post-date">
      
      <time>25 Aug 2018</time>
      
       |
      <div class="post-tags">
      
        <a href="/tag/swift">Swift</a>,
      
        <a href="/tag/foundation">Foundation</a>
      
      </div>
      
    </div>
    <p>Recently, I discovered a curious thing about <code class="highlighter-rouge">Date</code>s in two large projects
I work on. Simply put, both projects receives, from various HTTP endpoints, the
same object component: a timestamp, and a duration. Combining these two pieces,
both projects derives two <code class="highlighter-rouge">Foundation.Date</code>s to represent a time range. So far,
so good.</p>

<p>However, project <code class="highlighter-rouge">A</code> uses <code class="highlighter-rouge">Fonudation.DateInterval</code> to represent this concept,
while project <code class="highlighter-rouge">B</code> uses <code class="highlighter-rouge">Range&lt;Date&gt;</code>. But why? Why represent the same component
differently? What a gigantic waste of brain power for everyone on both projects!</p>

<p>So I set out to unify this thing. Wherever a <code class="highlighter-rouge">Range</code> literal is used, I swap in
<code class="highlighter-rouge">DateInterval.init(start:end:)</code>; <code class="highlighter-rouge">Range.lowerBound</code> becomes
<code class="highlighter-rouge">DateInterval.start</code>; <code class="highlighter-rouge">Range.upperBound</code> becomes <code class="highlighter-rouge">DateInterval.end</code>, etc. It
didn‚Äôt take long to complete the conversion to <code class="highlighter-rouge">DateInterval</code> in project <code class="highlighter-rouge">B</code>,
now it builds and runs!</p>

<p>Oh, wait, why are some tests failing in project <code class="highlighter-rouge">B</code>? Shouldn‚Äôt this just be an
mechanical change?</p>

<p>I spent time investigating. The failing tests are for some very specific
business logic that I‚Äôm not familiar with. So things took a while to become
clear. What felt like a long time later, I realized my mistake.</p>

<p>(I‚Äôm sorry if this has been obvious to you. You are a better Swift programmer!)</p>

<p>Somewhere in project <code class="highlighter-rouge">B</code> is the following:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">Item</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">range</span><span class="p">:</span> <span class="kt">Range</span><span class="o">&lt;</span><span class="kt">Date</span><span class="o">&gt;</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="kt">Container</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">items</span><span class="p">:</span> <span class="p">[</span><span class="kt">Item</span><span class="p">]</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">containerFactory</span><span class="p">(</span><span class="nv">range</span><span class="p">:</span> <span class="kt">Range</span><span class="o">&lt;</span><span class="kt">Date</span><span class="o">&gt;</span><span class="p">,</span> <span class="nv">items</span><span class="p">:</span> <span class="p">[</span><span class="kt">Item</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kt">Container</span> <span class="p">{</span>
    <span class="c1">/// pretend there's more code here</span>

    <span class="k">return</span> <span class="kt">Conatiner</span><span class="p">(</span><span class="nv">items</span><span class="p">:</span> <span class="n">items</span><span class="o">.</span><span class="n">filter</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">range</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">range</span><span class="o">.</span><span class="n">lowerBound</span><span class="p">)</span> <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And of course, after my ‚Äúrefactor‚Äù, it became</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">Item</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">range</span><span class="p">:</span> <span class="kt">DateInterval</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="kt">Container</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">items</span><span class="p">:</span> <span class="p">[</span><span class="kt">Item</span><span class="p">]</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">containerFactory</span><span class="p">(</span><span class="nv">range</span><span class="p">:</span> <span class="kt">DateInterval</span><span class="p">,</span> <span class="nv">items</span><span class="p">:</span> <span class="p">[</span><span class="kt">Item</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kt">Container</span> <span class="p">{</span>
    <span class="c1">/// pretend there's more code here</span>

    <span class="k">return</span> <span class="kt">Conatiner</span><span class="p">(</span><span class="nv">items</span><span class="p">:</span> <span class="n">items</span><span class="o">.</span><span class="n">filter</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">range</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">range</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Tests for <code class="highlighter-rouge">containerFactory</code> failed. And here‚Äôs why: <strong><code class="highlighter-rouge">DateInterval.contains</code>
is inclusive for its upper bound (<code class="highlighter-rouge">.end</code>), whereas <code class="highlighter-rouge">Range.contains</code> isn‚Äôt!</strong> You
can see it plainly by running the following</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">Foundation</span>

<span class="k">let</span> <span class="nv">sooner</span> <span class="o">=</span> <span class="kt">Date</span><span class="p">(</span><span class="nv">timeIntervalSince1970</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">later</span> <span class="o">=</span> <span class="n">sooner</span><span class="o">.</span><span class="nf">addingTimeInterval</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>

<span class="kt">DateInterval</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="n">sooner</span><span class="p">,</span> <span class="nv">end</span><span class="p">:</span> <span class="n">later</span><span class="p">)</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">later</span><span class="p">)</span> <span class="c1">// true</span>
<span class="p">(</span><span class="n">sooner</span><span class="o">..&lt;</span><span class="n">later</span><span class="p">)</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">later</span><span class="p">)</span>                        <span class="c1">// false</span>
</code></pre></div></div>

<p>So here‚Äôs what stumped me:</p>

<ol>
  <li>
    <p>The 2 projects chose to interpret the same component differently, which
I didn‚Äôt not expect.</p>
  </li>
  <li>
    <p>I didn‚Äôt know how <code class="highlighter-rouge">Foundation.DateInterval</code> works.</p>
  </li>
</ol>

<p>Well, today I learned.</p>

  </div>
  <hr />
  
  <div class="content post">
    
    <h1 class="post-title"><a href="/2018/08/18/supporting-data-without-depending-on-it/">Supporting Foundation.Data Without Depending On It</a></h1>
    
    <div class="post-date">
      
      <time>18 Aug 2018</time>
      
       |
      <div class="post-tags">
      
        <a href="/tag/swift">Swift</a>,
      
        <a href="/tag/foundation">Foundation</a>
      
      </div>
      
    </div>
    <p>While implementing some file I/O APIs in <a href="https://github.com/dduan/Pathos">Pathos</a>, I decided reading/writing
file content as <code class="highlighter-rouge">Foundation.Data</code> is kind of important (can you blame me?). But
Pathos, by accident, does not depend on Swift <code class="highlighter-rouge">Foundation</code>. Now what?</p>

<p>After browsing the <a href="https://developer.apple.com/documentation/foundation/data">documentation</a>, a pretty good solution emerged: <code class="highlighter-rouge">Data</code> is
a sequence of bytes! Lets say we hand our users some bytes, they can easily
construct a <code class="highlighter-rouge">Data</code> from it:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">content</span><span class="p">:</span> <span class="p">[</span><span class="kt">UInt8</span><span class="p">]</span> <span class="o">=</span> <span class="k">try</span> <span class="nf">readBytes</span><span class="p">(</span><span class="n">fromPath</span> <span class="s">"/tmp/test"</span><span class="p">)</span>
<span class="kt">Data</span><span class="p">(</span><span class="nv">bytes</span><span class="p">:</span> <span class="n">content</span><span class="p">)</span>
</code></pre></div></div>

<p>Okay, so this built-in initializer makes <code class="highlighter-rouge">[UInt8]</code> an acceptable substitute for
returning <code class="highlighter-rouge">Data</code>. What can we do about about <code class="highlighter-rouge">Data</code> as input? Well, turns out,
<code class="highlighter-rouge">Data</code> is a <code class="highlighter-rouge">Collection</code> of <code class="highlighter-rouge">UInt8</code>s! So we can accept <code class="highlighter-rouge">Data</code> indirectly like
so:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="n">write</span><span class="o">&lt;</span><span class="kt">Bytes</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">bytes</span><span class="p">:</span> <span class="kt">Bytes</span><span class="p">)</span>
    <span class="k">where</span> <span class="kt">Bytes</span><span class="p">:</span> <span class="kt">Collection</span><span class="p">,</span> <span class="kt">Bytes</span><span class="o">.</span><span class="kt">Element</span> <span class="o">==</span> <span class="kt">UInt8</span>
<span class="p">{</span>
    <span class="c1">// blah</span>
<span class="p">}</span>
</code></pre></div></div>

<p>User can pass in a <code class="highlighter-rouge">Data</code> as argument and it just works‚Ñ¢.</p>

<p>The only disadvantage of supporting <code class="highlighter-rouge">Data</code> in these ways is that it requires
your user to discover it either via your excellent documentation, or through
their super good knowledge of <code class="highlighter-rouge">Foundation</code>.</p>

<p><em>Update: this could also <a href="https://mastodon.social/@helge/100573358160444340">be</a> <a href="https://twitter.com/daniel_dunbar/status/1030938273047179264">slower</a> than using Data directly. Luckily
I‚Äôm only doing file I/O here.</em></p>

<p>But this is pretty nice, regardless.</p>


  </div>
  <hr />
  


<footer class="masthead">
<h4>Read More:</h4>
<nav class="masthead-nav">
  
  <a href="/articles">articles</a>
  
  <a href="https://www.youtube.com/channel/UCkBVC0dMgyUnxzettP7qE-A">videos</a>
  
  <a href="/links">Links</a>
  
  <a href="/projects">Projects</a>
  
  <a href="/about">About</a>
  
</nav>
</footer>

</div>

  </div>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)
    },i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-59501714-1', 'auto');
    ga('send', 'pageview');
  </script>
</body>
</html>
