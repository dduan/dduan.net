<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Daniel Duan</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:300,300i,600">
  <link rel="stylesheet" href="/style.css">
  <link rel="alternate" type="application/rss+xml" title="RSS Feed for Daniel Duan" href="/feed.xml" />
  <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Daniel Duan | Daniel Duan’s Thoughts And Works.</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Daniel Duan" />
<meta name="author" content="Daniel Duan" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Daniel Duan’s Thoughts And Works." />
<meta property="og:description" content="Daniel Duan’s Thoughts And Works." />
<link rel="canonical" href="https://duan.ca/" />
<meta property="og:url" content="https://duan.ca/" />
<meta property="og:site_name" content="Daniel Duan" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@daniel_duan" />
<meta name="twitter:creator" content="@Daniel Duan" />
<script type="application/ld+json">
{"@type":"WebSite","url":"https://duan.ca/","name":"Daniel Duan","author":{"@type":"Person","name":"Daniel Duan"},"description":"Daniel Duan’s Thoughts And Works.","headline":"Daniel Duan","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>
<body>
  <div class="container">
    <header class="masthead">
  <h1 class="masthead-title">
    <a href="/">Daniel Duan<span>&#39;s blog</span></a>
  </h1>
  <nav class="masthead-nav">
    
    <a href="/articles">articles</a>
    
    <a href="https://www.youtube.com/channel/UCkBVC0dMgyUnxzettP7qE-A">videos</a>
    
    <a href="/links">Links</a>
    
    <a href="/projects">Projects</a>
    
    <a href="/about">About</a>
    
  </nav>
</header>
<div class="content page">
  <h3 class="page-title"></h3>
  


  
  <div class="content post">
    
    <h1 class="post-title"><a href="/2019/07/01/combine-hygiene/">On the Subject of Interface Hygiene</a></h1>
    
    <div class="post-date">
      
      <time>01 Jul 2019</time>
      
       |
      <div class="post-tags">
      
        <a href="/tag/combine">Combine</a>,
      
        <a href="/tag/swift">Swift</a>
      
      </div>
      
    </div>
    <p>In a purly reactive world, your entire program should be a single stream. Now,
close your eyes, and envision: your project as one, beautiful, stream.</p>

<p>Now open your eyes. Yeah, it’s not. Your project is a Mac or iOS app. It’s full
of your memories, sweat, blood. Now you are ready to sweat and bleed some more
by putting some Combine and SwiftUI into it. You watched the WWDC19 sessions and
learned that “Subjcets are super powerful”. You looked into your code and
realized you can’t really do anything with Combine without <code class="highlighter-rouge">Subject</code>s at the
current state of the project.</p>

<p>Well…</p>

<p>Here are a few habits that help keeping your project that prevasively uses
<code class="highlighter-rouge">Combine.Subject</code> <em>sane</em>. They should seem obvious to anyone who understands
murphy’s law and the value of minialism in interfaces. If you already are using
some reactive stream implementation, substitute the types with their
counterparts in your framework and these rules should seem down right <strong>basic</strong>.</p>

<h2 id="disguise-subjects-as-publishers">Disguise <code class="highlighter-rouge">Subject</code>s as <code class="highlighter-rouge">Publisher</code>s</h2>

<p><code class="highlighter-rouge">Subject</code>s help bridge from the imperitive to the reactive world. Somewhat
paradoxically, sharing them is not very “RX-y”. This is akin to prefering <code class="highlighter-rouge">let</code>s
over <code class="highlighter-rouge">var</code>: sharing the stream, but not the previlage of mutating it.</p>

<p>Most of the time, what you want to share is the values pumped into the stream.
Because Subjects conform to <code class="highlighter-rouge">Publisher</code>, it’s easy to hide from the users the
fact that your stream is backed by them. With Combine this conversion
happens via type-erasure:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Bad: now anyone who get a hold of it can mess with your stream!</span>
<span class="kd">public</span> <span class="kd">enum</span> <span class="kt">GreatInts</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">updates</span> <span class="o">=</span> <span class="kt">CurrentValueSubject</span><span class="o">&lt;</span><span class="kt">Int</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Better: all your users care is the stream (publisher), so give them that!</span>
<span class="kd">public</span> <span class="kd">enum</span> <span class="kt">GreatInts</span> <span class="p">{</span>
    <span class="c1">// Internally, it's backed by a subject.</span>
    <span class="k">var</span> <span class="nv">subject</span> <span class="o">=</span> <span class="kt">CurrentValueSubject</span><span class="o">&lt;</span><span class="kt">Int</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1">// Externally, it's just a Publisher. </span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">subject</span><span class="p">:</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Int</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="n">subject</span><span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="currentvaluesubject-natually-caches-the-latest-value">CurrentValueSubject natually caches the latest value</h2>

<p>RX theorists will hate this: sometimes it’s just practical to expose
a synchronous interface to the latest vaule in the stream!</p>

<p>Two things.</p>

<ol>
  <li>It might be tempting to expose the subject and let your user use its
<code class="highlighter-rouge">.value</code>. Well, you shouldn’t (as explained in the previous section).
A separate interface dedicated to the latest value prevents people from
polluting your stream.</li>
</ol>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// (Still) bad</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="kt">GreatInts</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">updates</span> <span class="o">=</span> <span class="kt">CurrentValueSubject</span><span class="o">&lt;</span><span class="kt">Int</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<ol>
  <li>Remember <code class="highlighter-rouge">CurrentValueSubject</code> has that <code class="highlighter-rouge">.value</code> property! It may seem
surprising, but I’ve seen folks transitioning to RX clinging to the old ways:</li>
</ol>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="kt">GreatInts</span> <span class="p">{</span>
    <span class="c1">// well, at least it's not a public subject...</span>
    <span class="k">var</span> <span class="nv">subject</span> <span class="o">=</span> <span class="kt">CurrentValueSubject</span><span class="o">&lt;</span><span class="kt">Int</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1">// &lt;- initial value 0</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">updates</span><span class="p">:</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Int</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="n">subject</span><span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="c1">// Wait, there's that 0 again</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">latest</span><span class="p">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="k">didSet</span> <span class="p">{</span>
            <span class="n">subject</span><span class="o">.</span><span class="nf">send</span><span class="p">(</span><span class="n">latest</span><span class="p">)</span> <span class="c1">// ?</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>First, you’ll notice that <code class="highlighter-rouge">0</code>, the initial value, is duplicated as both the
subject’s initial value, as well as the value of a stored property. And these
duplicated sources of truth persist throughout the parent’s life time. Weird,
right?</p>

<p>Here’s a slightly better version:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="kt">GreatInts</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">subject</span> <span class="o">=</span> <span class="kt">PassthroughSubject</span><span class="o">&lt;</span><span class="kt">Int</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span><span class="p">()</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">updates</span><span class="p">:</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Int</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="n">subject</span><span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="k">var</span> <span class="nv">latest</span><span class="p">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="k">didSet</span> <span class="p">{</span>
            <span class="n">subject</span><span class="o">.</span><span class="nf">send</span><span class="p">(</span><span class="n">latest</span><span class="p">)</span> <span class="c1">// ?</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now there’s no two copy of the latest value in memory anymore. But in my opinion
it does not embrace the full power of Combine. Here’s the most natual way to do
this:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="kt">GreatInts</span> <span class="p">{</span>
    <span class="c1">/// This is a CurrentValueSubject again.</span>
    <span class="k">var</span> <span class="nv">subject</span> <span class="o">=</span> <span class="kt">CurrentValueSubject</span><span class="o">&lt;</span><span class="kt">Int</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">updates</span><span class="p">:</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Int</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="n">subject</span><span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="k">var</span> <span class="nv">latest</span><span class="p">:</span> <span class="kt">Int</span> <span class="p">{</span>
        <span class="n">subject</span><span class="o">.</span><span class="n">value</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Essentially, you create separate public interface, each vends a little piece of
<code class="highlighter-rouge">CurrentValueSubject</code>’s power.</p>

<h2 id="no-really-dont-use-subjects">No really, don’t use <code class="highlighter-rouge">Subject</code>s</h2>

<p>Even a well-scoped <code class="highlighter-rouge">Subject</code> (properly being private or internal, depending on
your tool of choice for access control) still has a mutable state that you
probably don’t want: its stream can go from “alive” to “complete”. And, again,
anyone with access can make this state transition happen, leaving you in the
undefensible position of … hoping everyone on your team to not misuse your
stuff?</p>

<p>Lucky for you (and me), a “incompletable” subject is a established concept – a
“Relay”. I’ve put together a repo for you to look and/or use:</p>

<p><a href="https://github.com/dduan/relay">https://github.com/dduan/relay</a></p>

<p>Yeah, ban all Subjects in your project with a linter. Seriously.</p>

<h2 id="fin">Fin</h2>

<p>That’s all for now. I’m not an expert with RX myself. Hopefully these
perspective can help you avoid some nasties.</p>

  </div>
  <hr />
  
  <div class="content post">
    
    <h1 class="post-title"><a href="/2019/03/10/toml-decoder/">TOML Decoder Playlist</a></h1>
    
    <div class="post-date">
      
      <time>10 Mar 2019</time>
      
       |
      <div class="post-tags">
      
        <a href="/tag/toml">TOML</a>,
      
        <a href="/tag/swift">Swift</a>,
      
        <a href="/tag/youtube">YouTube</a>,
      
        <a href="/tag/twitch">Twitch</a>
      
      </div>
      
    </div>
    <p>I enjoyed making <a href="https://github.com/dduan/TOMLDeserializer">TOMLDeserializer</a> and <a href="https://github.com/dduan/TOMLDecoder">TOMLDecoder</a> recently. Let’s hope
some projects will pick them up and TOML as a configuration format will start to
spead in Swift communities.</p>

<p>What’s outstanding about these projects is that I started working on them while
<a href="https://twitch.tv/daniel_duan">streaming</a>. Personally, I consume a lot of content like this. So now people
can watch me writing Swift, too.</p>

<p>I’ve been archiving recordings of these streams as much as I can. Here are the
links to these videos, each is around 1-1.5 hours long:</p>

<ul>
  <li><a href="https://youtu.be/XLLlCEfuFLw">Turn TOML Test Fixtures Into XCTests With Vim Macros</a></li>
  <li><a href="https://youtu.be/Ztq3K3cq8f0">Passing TOML Deserialization Tests</a></li>
  <li><a href="https://youtu.be/GTCYSIc6n3U">Finishing TOML Invalidation Tests</a></li>
  <li><a href="https://youtu.be/HP2Wzh8MVvg">TOML Decoder: The Beginning</a></li>
  <li><a href="https://youtu.be/EZ7VpbrLkH0">TOML Decoder: Filling In Missing Implementation Pieces</a></li>
  <li><a href="https://youtu.be/bISMVVWOHKg">TOML Decoder: Adding The First TOML Decoding Strategy!</a></li>
  <li><a href="https://youtu.be/oOOS4bnhwx4">TOML Decoder: Project Overview And Data Decoding Support</a></li>
  <li><a href="https://youtu.be/9yDtXsrMtbU">TOML Decoder: Key Decoding Strategies</a></li>
  <li><a href="https://youtu.be/g1V872HL4Dk">TOML Decoder: Project Updates</a></li>
</ul>

<p>The TOMLDecoder projects would’ve been capture on camera entirely if I weren’t
such a streaming n00b and messed up a few streams. Hilarious.</p>


  </div>
  <hr />
  
  <div class="content post">
    
    <h1 class="post-title"><a href="/2019/01/20/kick-ass-cli-tools-in-swift/">Kick-ass CLI Tools In Swift</a></h1>
    
    <div class="post-date">
      
      <time>20 Jan 2019</time>
      
       |
      <div class="post-tags">
      
        <a href="/tag/swift">Swift</a>,
      
        <a href="/tag/cli">CLI</a>,
      
        <a href="/tag/posix">POSIX</a>
      
      </div>
      
    </div>
    <p>As someone who lives in a terminal simulator, I’m pleasantly surprised by the
new toys we get in recent years such as <a href="https://github.com/junegunn/fzf">fzf</a>, <a href="https://github.com/BurntSushi/ripgrep">ripgrep</a>, <a href="https://github.com/sharkdp/fd">fd</a>, etc.
A great number of these are written in relatively young programming languages
such as Go and Rust. But, noticibly, none of them are written in Swift.</p>

<p>In this post, I’ll try to explain why that is.</p>

<h2 id="posix-ergonomics">POSIX Ergonomics</h2>

<p>Unix-like virtual file systems has been around for decades. API that manupulates
such systems has standardized a long time ago and exists in most computers
running Linux/BSD/macOS today (and, to a large extend, smart phones). To Swift
users, Using these APIs is straight-forward (<code class="highlighter-rouge">rmdir("path/to/dir")</code>).</p>

<p>So Swift programmers are all happy campers (re-)inventeing all sorts of file
system utilities, right?</p>

<p>Well, not quite.</p>

<p>Okay, I lied about POSIX APIs being “straight-forward” in Swift. Or rather, this
is very subjective.</p>

<p>Continuing with the <code class="highlighter-rouge">rmdir</code> example, we must first import it from either <code class="highlighter-rouge">Glibc</code>
or <code class="highlighter-rouge">Darwin</code>, depending on your OS. To know whether the operation is successful,
we need to see whether it returned integer 0. To learn <em>why</em> 0 was not returned,
we need to read the “magical” variable <code class="highlighter-rouge">errno</code>. <code class="highlighter-rouge">errno</code> could be written to by
other APIs so we’d better capture it in time…</p>

<p>And that’s one of the simpler APIs in POSIX calls!</p>

<p>Programmers whine about ergonomics partially because we are previlidged and
spoiled. But mostly because our attention is a limited resources. Mixing API
conventions distracts us from solving the problem at hand. Bad ergonomics,
therefore, drives away a good potion of users who cares about quality of their
tools.</p>

<h2 id="culture-and-history">Culture and History</h2>

<p>As of this writing, the release of Swift 5 is imminent. The vast majority of
existing Swift code is written to run on iOS. The concept of a file, or the
traditional virtal file system, is hidden to iOS users, and sandboxed for
developers. I bet most Swift users rarely think about the fact that there’s
a entire set of POSIX API at their disposal.</p>

<p><code class="highlighter-rouge">Foundation</code> alleviates the need to deal with files and directories: <code class="highlighter-rouge">Bundle</code>
locates the files; <code class="highlighter-rouge">CoreData</code>, <code class="highlighter-rouge">UserDefaults</code> or the keychain is your primary
way to persist data; <code class="highlighter-rouge">Data</code>, <code class="highlighter-rouge">String</code> or <code class="highlighter-rouge">NSCoding</code> has methods to read and
write to files.  And finally, if you really need to deal with files,
<code class="highlighter-rouge">NSFileManager</code> has everything you’ll ever need.</p>

<p>Why would a productive Swift programmer think about POSIX in this environment?
Why would a tutor teach POSIX over the useful/practical/”native” alternatives?</p>

<p>We can trace “riding on the Apple platform” mentality back to the pre-iPhone
days, where a very small Mac developer community labors on on a niche platform
(compared to iOS today) and they <em>loved</em> it. However, I’m sure they used more
POSIX stuff back then than the average iOS developers today.</p>

<p>Having a great library such as Foundation on the most popular developer
platform where the language thrives means it’ll take longer for “subcultures”
to emerge, if they do at all.</p>

<h2 id="the-standard-library-and-its-influence-on-new-users">The Standard Library And Its Influence on New Users</h2>

<p>File system APIs being in <code class="highlighter-rouge">Foundation</code> as opposed to the standard library is
probably a temporary condition. Nevertheless, it has at least the following
implications:</p>

<ol>
  <li>
    <p>Its quality of implementation is not held on the same standard that those
APIs in the standard library. This is especially true for the separate,
open-source <code class="highlighter-rouge">Foundation</code> implementation. Getting consistent and correct
behaviors across macOS and Linux is hard.</p>
  </li>
  <li>
    <p>A person learning Swift won’t explore the language with a file system API.
This I suspect, is <strong>the most important reason many of these great CLI
utilites are written in other programming languages</strong>. Programmers seek
instant gratification when they learn. And they usually stay in a limited
domain (like iOS) at first. This is where the built-in library is special: no
matter which domain is chosen, it’s always available. Languages such as Go
and Rust include things like paths and files in their built-in library.
Playing with these APIs while learning the lanugage plants a seed for future,
serious, projects. There are less users of these languages compared to Swift,
but there are more people thinking about projects that involves file systems
in thoes communities. (Note I don’t have statistics here, just a guess.)</p>
  </li>
</ol>

<h2 id="conclusion">Conclusion</h2>

<p>The next killer CLI tool is still more likely to be written in Go or Rust,
than in Swift. Hopefully, somewhere in these speculations is a true cause of
this phenomena. Maybe someone reading this will be inspired to accelerate change
that will eventually revert the condition. (I’m <a href="https://github.com/dduan/Pathos">trying</a>).</p>


  </div>
  <hr />
  


<footer class="masthead">
<h4>Read More:</h4>
<nav class="masthead-nav">
  
  <a href="/articles">articles</a>
  
  <a href="https://www.youtube.com/channel/UCkBVC0dMgyUnxzettP7qE-A">videos</a>
  
  <a href="/links">Links</a>
  
  <a href="/projects">Projects</a>
  
  <a href="/about">About</a>
  
</nav>
</footer>

</div>

  </div>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)
    },i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-59501714-1', 'auto');
    ga('send', 'pageview');
  </script>
</body>
</html>
